<html><head><meta http-equiv="Content-Type" content="text/html; charset=ANSI_X3.4-1968"><title>Chapter&#160;1.&#160;Common API Elements</title><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="LINUX MEDIA INFRASTRUCTURE API"><link rel="up" href="v4l2spec.html" title="Part&#160;I.&#160;Video for Linux Two API Specification"><link rel="prev" href="v4l2spec.html" title="Part&#160;I.&#160;Video for Linux Two API Specification"><link rel="next" href="querycap.html" title="Querying Capabilities"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&#160;1.&#160;Common API Elements</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="v4l2spec.html">Prev</a>&#160;</td><th width="60%" align="center">Part&#160;I.&#160;Video for Linux Two API Specification</th><td width="20%" align="right">&#160;<a accesskey="n" href="querycap.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter&#160;1.&#160;Common API Elements"><div class="titlepage"><div><div><h2 class="title"><a name="common"></a>Chapter&#160;1.&#160;Common API Elements</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="common.html#open">Opening and Closing Devices</a></span></dt><dd><dl><dt><span class="section"><a href="common.html#idp3287608">Device Naming</a></span></dt><dt><span class="section"><a href="common.html#related">Related Devices</a></span></dt><dt><span class="section"><a href="common.html#idp3297792">Multiple Opens</a></span></dt><dt><span class="section"><a href="common.html#idp3305792">Shared Data Streams</a></span></dt><dt><span class="section"><a href="common.html#idp3306624">Functions</a></span></dt></dl></dd><dt><span class="section"><a href="querycap.html">Querying Capabilities</a></span></dt><dt><span class="section"><a href="app-pri.html">Application Priority</a></span></dt><dt><span class="section"><a href="video.html">Video Inputs and Outputs</a></span></dt><dt><span class="section"><a href="audio.html">Audio Inputs and Outputs</a></span></dt><dt><span class="section"><a href="tuner.html">Tuners and Modulators</a></span></dt><dd><dl><dt><span class="section"><a href="tuner.html#idp3344920">Tuners</a></span></dt><dt><span class="section"><a href="tuner.html#idp3350976">Modulators</a></span></dt><dt><span class="section"><a href="tuner.html#idp3357112">Radio Frequency</a></span></dt></dl></dd><dt><span class="section"><a href="standard.html">Video Standards</a></span></dt><dt><span class="section"><a href="dv-timings.html">Digital Video (DV) Timings</a></span></dt><dt><span class="section"><a href="control.html">User Controls</a></span></dt><dt><span class="section"><a href="extended-controls.html">Extended Controls</a></span></dt><dd><dl><dt><span class="section"><a href="extended-controls.html#idp3515136">Introduction</a></span></dt><dt><span class="section"><a href="extended-controls.html#idp3517600">The Extended Control API</a></span></dt><dt><span class="section"><a href="extended-controls.html#idp3529672">Enumerating Extended Controls</a></span></dt><dt><span class="section"><a href="extended-controls.html#idp3424800">Creating Control Panels</a></span></dt><dt><span class="section"><a href="extended-controls.html#mpeg-controls">Codec Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#camera-controls">Camera Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#fm-tx-controls">FM Transmitter Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#flash-controls">Flash Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#jpeg-controls">JPEG Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#image-source-controls">Image Source Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#image-process-controls">Image Process Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#dv-controls">Digital Video Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#fm-rx-controls">FM Receiver Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#detect-controls">Detect Control Reference</a></span></dt><dt><span class="section"><a href="extended-controls.html#rf-tuner-controls">RF Tuner Control Reference</a></span></dt></dl></dd><dt><span class="section"><a href="format.html">Data Formats</a></span></dt><dd><dl><dt><span class="section"><a href="format.html#idp5419488">Data Format Negotiation</a></span></dt><dt><span class="section"><a href="format.html#idp5438200">Image Format Enumeration</a></span></dt></dl></dd><dt><span class="section"><a href="planar-apis.html">Single- and multi-planar APIs</a></span></dt><dd><dl><dt><span class="section"><a href="planar-apis.html#idp5446768">Multi-planar formats</a></span></dt><dt><span class="section"><a href="planar-apis.html#idp5447736">Calls that distinguish between single and multi-planar APIs</a></span></dt></dl></dd><dt><span class="section"><a href="crop.html">Image Cropping, Insertion and Scaling</a></span></dt><dd><dl><dt><span class="section"><a href="crop.html#idp5462272">Cropping Structures</a></span></dt><dt><span class="section"><a href="crop.html#idp5479696">Scaling Adjustments</a></span></dt><dt><span class="section"><a href="crop.html#idp5470200">Examples</a></span></dt></dl></dd><dt><span class="section"><a href="selection-api.html">Experimental API for cropping, composing and scaling</a></span></dt><dd><dl><dt><span class="section"><a href="selection-api.html#idp5507640">Introduction</a></span></dt><dt><span class="section"><a href="selection-api.html#idp5544824">Selection targets</a></span></dt><dt><span class="section"><a href="selection-api.html#idp5548096">Configuration</a></span></dt><dt><span class="section"><a href="selection-api.html#idp5566768">Comparison with old cropping API</a></span></dt><dt><span class="section"><a href="selection-api.html#idp5571368">Examples</a></span></dt></dl></dd><dt><span class="section"><a href="streaming-par.html">Streaming Parameters</a></span></dt></dl></div><p>Programming a V4L2 device consists of these
steps:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Opening the device</p></li><li class="listitem"><p>Changing device properties, selecting a video and audio
input, video standard, picture brightness a.&#160;o.</p></li><li class="listitem"><p>Negotiating a data format</p></li><li class="listitem"><p>Negotiating an input/output method</p></li><li class="listitem"><p>The actual input/output loop</p></li><li class="listitem"><p>Closing the device</p></li></ul></div><p>In practice most steps are optional and can be executed out of
order. It depends on the V4L2 device type, you can read about the
details in <a class="xref" href="devices.html" title="Chapter&#160;4.&#160;Interfaces">Chapter&#160;4, <i>Interfaces</i></a>. In this chapter we will discuss
the basic concepts applicable to all devices.</p><div class="section" title="Opening and Closing Devices"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="open"></a>Opening and Closing Devices</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="common.html#idp3287608">Device Naming</a></span></dt><dt><span class="section"><a href="common.html#related">Related Devices</a></span></dt><dt><span class="section"><a href="common.html#idp3297792">Multiple Opens</a></span></dt><dt><span class="section"><a href="common.html#idp3305792">Shared Data Streams</a></span></dt><dt><span class="section"><a href="common.html#idp3306624">Functions</a></span></dt></dl></div><div class="section" title="Device Naming"><div class="titlepage"><div><div><h3 class="title"><a name="idp3287608"></a>Device Naming</h3></div></div></div><p>V4L2 drivers are implemented as kernel modules, loaded
manually by the system administrator or automatically when a device is
first discovered. The driver modules plug into the "videodev" kernel
module. It provides helper functions and a common application
interface specified in this document.</p><p>Each driver thus loaded registers one or more device nodes
with major number 81 and a minor number between 0 and 255. Minor numbers
are allocated dynamically unless the kernel is compiled with the kernel
option CONFIG_VIDEO_FIXED_MINOR_RANGES. In that case minor numbers are
allocated in ranges depending on the device node type (video, radio, etc.).</p><p>Many drivers support "video_nr", "radio_nr" or "vbi_nr"
module options to select specific video/radio/vbi node numbers. This allows
the user to request that the device node is named e.g. /dev/video5 instead
of leaving it to chance. When the driver supports multiple devices of the same
type more than one device node number can be assigned, separated by commas:
	</p><div class="informalexample"><pre class="screen">
&gt; modprobe mydriver video_nr=0,1 radio_nr=0,1</pre></div><p>In <code class="filename">/etc/modules.conf</code> this may be
written as: </p><div class="informalexample"><pre class="screen">
options mydriver video_nr=0,1 radio_nr=0,1
	  </pre></div><p> When no device node number is given as module
option the driver supplies a default.</p><p>Normally udev will create the device nodes in /dev automatically
for you. If udev is not installed, then you need to enable the
CONFIG_VIDEO_FIXED_MINOR_RANGES kernel option in order to be able to correctly
relate a minor number to a device node number. I.e., you need to be certain
that minor number 5 maps to device node name video5. With this kernel option
different device types have different minor number ranges. These ranges are
listed in <a class="xref" href="devices.html" title="Chapter&#160;4.&#160;Interfaces">Chapter&#160;4, <i>Interfaces</i></a>.
</p><p>The creation of character special files (with
<span class="application">mknod</span>) is a privileged operation and
devices cannot be opened by major and minor number. That means
applications cannot <span class="emphasis"><em>reliable</em></span> scan for loaded or
installed drivers. The user must enter a device name, or the
application can try the conventional device names.</p></div><div class="section" title="Related Devices"><div class="titlepage"><div><div><h3 class="title"><a name="related"></a>Related Devices</h3></div></div></div><p>Devices can support several functions. For example
video capturing, VBI capturing and radio support.</p><p>The V4L2 API creates different nodes for each of these functions.</p><p>The V4L2 API was designed with the idea that one device node could support
all functions. However, in practice this never worked: this 'feature'
was never used by applications and many drivers did not support it and if
they did it was certainly never tested. In addition, switching a device
node between different functions only works when using the streaming I/O
API, not with the read()/write() API.</p><p>Today each device node supports just one function.</p><p>Besides video input or output the hardware may also
support audio sampling or playback. If so, these functions are
implemented as ALSA PCM devices with optional ALSA audio mixer
devices.</p><p>One problem with all these devices is that the V4L2 API
makes no provisions to find these related devices. Some really
complex devices use the Media Controller (see <a class="xref" href="media_controller.html" title="Chapter&#160;18.&#160;Media Controller">Chapter&#160;18, <i>Media Controller</i></a>)
which can be used for this purpose. But most drivers do not use it,
and while some code exists that uses sysfs to discover related devices
(see libmedia_dev in the <a class="ulink" href="http://git.linuxtv.org/cgit.cgi/v4l-utils.git/" target="_top">v4l-utils</a>
git repository), there is no library yet that can provide a single API towards
both Media Controller-based devices and devices that do not use the Media Controller.
If you want to work on this please write to the linux-media mailing list: <a class="ulink" href="http://www.linuxtv.org/lists.php" target="_top">http://www.linuxtv.org/lists.php</a>.</p></div><div class="section" title="Multiple Opens"><div class="titlepage"><div><div><h3 class="title"><a name="idp3297792"></a>Multiple Opens</h3></div></div></div><p>V4L2 devices can be opened more than once.<sup>[<a name="idp3297536" href="common.html#ftn.idp3297536" class="footnote">1</a>]</sup>
When this is supported by the driver, users can for example start a
"panel" application to change controls like brightness or audio
volume, while another application captures video and audio. In other words, panel
applications are comparable to an ALSA audio mixer application.
Just opening a V4L2 device should not change the state of the device.<sup>[<a name="idp3298816" href="common.html#ftn.idp3298816" class="footnote">2</a>]</sup></p><p>Once an application has allocated the memory buffers needed for
streaming data (by calling the <a class="link" href="vidioc-reqbufs.html" title="ioctl VIDIOC_REQBUFS"><code class="constant">VIDIOC_REQBUFS</code></a> or <a class="link" href="vidioc-create-bufs.html" title="ioctl VIDIOC_CREATE_BUFS"><code class="constant">VIDIOC_CREATE_BUFS</code></a> ioctls,
or implicitly by calling the <a class="link" href="func-read.html" title="V4L2 read()"><code class="function">read()</code></a> or <a class="link" href="func-write.html" title="V4L2 write()"><code class="function">write()</code></a> functions) that
application (filehandle) becomes the owner of the device. It is no longer
allowed to make changes that would affect the buffer sizes (e.g. by calling
the <a class="link" href="vidioc-g-fmt.html" title="ioctl VIDIOC_G_FMT, VIDIOC_S_FMT, VIDIOC_TRY_FMT"><code class="constant">VIDIOC_S_FMT</code></a> ioctl) and other applications are no longer allowed to allocate
buffers or start or stop streaming. The <span class="errorcode">EBUSY</span> error code will be returned instead.</p><p>Merely opening a V4L2 device does not grant exclusive
access.<sup>[<a name="idp3301272" href="common.html#ftn.idp3301272" class="footnote">3</a>]</sup> Initiating data exchange however assigns the right
to read or write the requested type of data, and to change related
properties, to this file descriptor. Applications can request
additional access privileges using the priority mechanism described in
<a class="xref" href="app-pri.html" title="Application Priority">the section called &#8220;Application Priority&#8221;</a>.</p></div><div class="section" title="Shared Data Streams"><div class="titlepage"><div><div><h3 class="title"><a name="idp3305792"></a>Shared Data Streams</h3></div></div></div><p>V4L2 drivers should not support multiple applications
reading or writing the same data stream on a device by copying
buffers, time multiplexing or similar means. This is better handled by
a proxy application in user space.</p></div><div class="section" title="Functions"><div class="titlepage"><div><div><h3 class="title"><a name="idp3306624"></a>Functions</h3></div></div></div><p>To open and close V4L2 devices applications use the
<a class="link" href="func-open.html" title="V4L2 open()"><code class="function">open()</code></a> and <a class="link" href="func-close.html" title="V4L2 close()"><code class="function">close()</code></a> function, respectively. Devices are
programmed using the <a class="link" href="func-ioctl.html" title="V4L2 ioctl()"><code class="function">ioctl()</code></a> function as explained in the
following sections.</p></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.idp3297536" href="common.html#idp3297536" class="para">1</a>] </sup>
There are still some old and obscure drivers that have not been updated to
allow for multiple opens. This implies that for such drivers <a class="link" href="func-open.html" title="V4L2 open()"><code class="function">open()</code></a> can
return an <span class="errorcode">EBUSY</span> error code when the device is already in use.</p></div><div class="footnote"><p><sup>[<a name="ftn.idp3298816" href="common.html#idp3298816" class="para">2</a>] </sup>Unfortunately, opening a radio device often switches the state of the
device to radio mode in many drivers. This behavior should be fixed eventually
as it violates the V4L2 specification.</p></div><div class="footnote"><p><sup>[<a name="ftn.idp3301272" href="common.html#idp3301272" class="para">3</a>] </sup>Drivers could recognize the
<code class="constant">O_EXCL</code> open flag. Presently this is not required,
so applications cannot know if it really works.</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="v4l2spec.html">Prev</a>&#160;</td><td width="20%" align="center"><a accesskey="u" href="v4l2spec.html">Up</a></td><td width="40%" align="right">&#160;<a accesskey="n" href="querycap.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part&#160;I.&#160;Video for Linux Two API Specification&#160;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&#160;Querying Capabilities</td></tr></table></div></body></html>
